# üêç Activity 03: Python Code Execution Tool - Student Practice Guide

## üéØ Learning Objectives

By the end of this activity, you will:
- Build a Python code execution tool using LangChain's PythonREPL
- Learn to handle dynamic code execution safely in agent workflows
- Master the integration of computational tools with external libraries
- Complete your three-tool financial analysis toolkit
- Understand how agents can generate and execute code autonomously

## üìö Background Context

**What is the Python REPL Tool?**
You're building the final component of your financial analysis system:
1. ‚úÖ **Wikipedia tool** ‚Üí Company information (completed in Activity 01)
2. ‚úÖ **Stock data tool** ‚Üí Historical stock performance (completed in Activity 02)
3. üîÑ **Python execution tool** ‚Üí Data visualization and calculations (this activity)

**Why Python Execution Tool?**
- **Dynamic Analysis**: Execute code generated by AI agents
- **Data Visualization**: Create charts and graphs from stock data
- **Mathematical Operations**: Perform complex calculations
- **Flexible Computing**: Handle any Python-based task

## üõ†Ô∏è Tool Capabilities

**What this tool can do:**
- Execute arbitrary Python code in a controlled environment
- Generate matplotlib visualizations
- Perform NumPy/Pandas calculations
- Handle data processing tasks
- Create dynamic reports and analysis

**Example Use Cases:**
```python
# Stock price trend analysis
"Create a line chart showing AAPL stock prices over the last 30 days"

# Financial calculations
"Calculate the moving average and standard deviation of Tesla stock"

# Data comparisons
"Generate a bar chart comparing the performance of tech stocks"
```

## üîß Setup Instructions

### Step 1: Install Required Libraries
```bash
pip install --quiet langchain-core==0.3.59 langchain-experimental==0.3.4
```

### Step 2: Import Dependencies
```python
# TODO: Import the required modules
# Hint: You need langchain_core.tools.tool, typing.Annotated, and langchain_experimental.utilities.PythonREPL
from langchain_core.tools import ________
from typing import ________
from langchain_experimental.utilities import ________
```

<details>
<summary>üí° Hint for Step 2</summary>

You need to import:
- `tool` from langchain_core.tools for the decorator
- `Annotated` from typing for parameter descriptions  
- `PythonREPL` from langchain_experimental.utilities for code execution
</details>

## üèóÔ∏è Building the Python Execution Tool

### Step 3: Initialize the REPL Environment

```python
# TODO: Step 3a - Create a PythonREPL instance
# Hint: Initialize the PythonREPL class
repl = ________()
```

<details>
<summary>üîç Step 3a Hint</summary>

Use `PythonREPL()` to create a new Python execution environment.
</details>

### Step 4: Create the Tool Function

**Your task:** Complete the `python_repl_tool` function below. You need to write about **60%** of the implementation.

```python
# TODO: Step 4a - Add the tool decorator
________
def python_repl_tool(
    code: Annotated[str, "The python code to execute to generate your chart."],
):
    """Use this to execute python code. If you want to see the output of a value,
    you should print it out with `print(...)`. This is visible to the user. The chart should be displayed using `plt.show()`."""
    try:
        # TODO: Step 4b - Execute the code using the repl
        # Hint: Use repl.run() method and pass the code parameter
        result = ________.________(________)
    except BaseException as e:
        return f"Failed to execute. Error: {repr(e)}"
    
    # TODO: Step 4c - Return formatted result with code and output
    # Hint: Include the original code and the execution result
    return f"""Successfully executed the Python REPL tool.

Python code executed:
```python
________
```

Code output:
```
________
```"""
```

<details>
<summary>üîç Step-by-Step Hints</summary>

**Step 4a:** Use `@tool` decorator
**Step 4b:** `repl.run(code)` executes Python code and returns results
**Step 4c:** Include both `code` and `result` in the return string
</details>

### Step 5: Test Your Tool

Test your Python execution tool with different scenarios:

```python
# TODO: Step 5a - Test with NumPy array operations
# Hint: Create a code string that imports numpy and performs array operations
code_numpy = f"""
import ________

arr = ________.arange(0, 9)
print(arr)
print(2 * arr)
"""

# TODO: Step 5b - Invoke the tool with the code
# Hint: Use .invoke() with a dictionary containing the code
result = python_repl_tool.invoke({"________": ________})
print(result)
```

<details>
<summary>üí° Testing Hints</summary>

- Import `numpy as np` 
- Use `np.arange(0, 9)` to create an array from 0 to 8
- Parameter name is `"code"` for the invoke method
- Pass the `code_numpy` variable as the value
</details>

### Step 6: Advanced Testing - Data Visualization

```python
# TODO: Step 6 - Test with matplotlib visualization
visualization_code = """
import matplotlib.pyplot as plt
import numpy as np

# Create sample stock data
days = np.arange(1, 11)
prices = [100, 102, 98, 105, 107, 103, 108, 110, 106, 112]

plt.figure(figsize=(10, 6))
plt.plot(days, prices, marker='o', linewidth=2, markersize=6)
plt.title('Sample Stock Price Trend', fontsize=14)
plt.xlabel('Days')
plt.ylabel('Stock Price ($)')
plt.grid(True, alpha=0.3)
plt.show()

print(f"Stock prices ranged from ${min(prices)} to ${max(prices)}")
"""

# TODO: Execute the visualization code
viz_result = ________.________({"________": ________})
print(viz_result)
```

## ‚úÖ Expected Output

Your tool should return something like:

```
Successfully executed the Python REPL tool.

Python code executed:
```python
import numpy as np

arr = np.arange(0, 9)
print(arr)
print(2 * arr)
```

Code output:
```
[0 1 2 3 4 5 6 7 8]
[ 0  2  4  6  8 10 12 14 16]
```

## üéì Understanding Your Code

### Key Concepts Explained:

**1. PythonREPL Environment:**
```python
repl = PythonREPL()
result = repl.run(code)
```
- Creates an isolated Python execution environment
- Maintains state between executions within the same session
- Safely executes code strings and captures output

**2. Code Execution Flow:**
```python
try:
    result = repl.run(code)
except BaseException as e:
    return f"Failed to execute. Error: {repr(e)}"
```
- Executes the provided Python code
- Captures both stdout and return values
- Handles all possible execution errors gracefully

**3. Dynamic Code Generation:**
```python
code = f"""
import numpy as np
arr = np.arange(0, 9)
print(arr)
"""
```
- AI agents can generate code strings dynamically
- F-strings allow for parameterized code generation
- Multi-line strings support complex code blocks

**4. Visualization Integration:**
```python
plt.figure(figsize=(10, 6))
plt.plot(days, prices, marker='o')
plt.show()  # Important: displays the chart
```
- `plt.show()` is crucial for displaying charts
- Charts are rendered in the execution environment
- Output includes both printed text and visual displays

## üîß Troubleshooting Guide

### Common Issues & Solutions:

**‚ùå "No module named 'langchain_experimental'"**
```bash
# Solution: Install the experimental package
pip install langchain-experimental==0.3.4
```

**‚ùå "AttributeError: 'PythonREPL' object has no attribute 'run'"**
- **Check:** Make sure you imported PythonREPL correctly
- **Solution:** Verify the import: `from langchain_experimental.utilities import PythonREPL`

**‚ùå Charts not displaying**
```python
# Problem: Missing plt.show()
plt.plot(data)  # Chart created but not displayed

# Solution: Always include plt.show()
plt.plot(data)
plt.show()  # This displays the chart
```

**‚ùå "SyntaxError in executed code"**
- **Check:** Your code string for syntax errors
- **Debug:** Test the code in a regular Python environment first
- **Tip:** Use triple quotes for multi-line strings

## üß™ Testing Challenges

### Challenge 1: Mathematical Operations
```python
# Test complex calculations
math_code = """
import math

def calculate_compound_interest(principal, rate, time):
    return principal * (1 + rate) ** time

# Calculate investment growth
initial = 1000
annual_rate = 0.07  # 7% annual return
years = 10

final_amount = calculate_compound_interest(initial, annual_rate, years)
print(f"Investment after {years} years: ${final_amount:.2f}")
print(f"Total growth: ${final_amount - initial:.2f}")
"""

result = python_repl_tool.invoke({"code": math_code})
print(result)
```

### Challenge 2: Data Processing
```python
# Test pandas data manipulation
pandas_code = """
import pandas as pd

# Create sample financial data
data = {
    'Company': ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA'],
    'Price': [150.25, 280.50, 2450.75, 3200.10, 800.30],
    'Volume': [50000, 45000, 25000, 30000, 75000],
    'Market_Cap': [2500, 2100, 1600, 1400, 800]  # in billions
}

df = pd.DataFrame(data)
print("Stock Data Summary:")
print(df)
print(f"\\nAverage Price: ${df['Price'].mean():.2f}")
print(f"Highest Volume: {df['Volume'].max():,}")
"""

result = python_repl_tool.invoke({"code": pandas_code})
print(result)
```

### Challenge 3: Advanced Visualization
```python
# Test multiple chart types
advanced_viz_code = """
import matplotlib.pyplot as plt
import numpy as np

# Create subplots for different chart types
fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(12, 8))

# Line chart
days = np.arange(1, 8)
aapl_prices = [145, 148, 142, 150, 155, 152, 158]
ax1.plot(days, aapl_prices, 'b-o')
ax1.set_title('AAPL Stock Price')
ax1.set_ylabel('Price ($)')

# Bar chart
companies = ['AAPL', 'MSFT', 'GOOGL']
returns = [12.5, 15.2, 8.7]
ax2.bar(companies, returns, color=['blue', 'green', 'red'])
ax2.set_title('Annual Returns (%)')
ax2.set_ylabel('Return (%)')

# Histogram
returns_data = np.random.normal(10, 3, 100)
ax3.hist(returns_data, bins=15, alpha=0.7, color='purple')
ax3.set_title('Return Distribution')
ax3.set_xlabel('Return (%)')

# Scatter plot
risk = [5, 8, 12, 15, 20]
return_rate = [8, 12, 15, 18, 22]
ax4.scatter(risk, return_rate, s=100, alpha=0.7)
ax4.set_title('Risk vs Return')
ax4.set_xlabel('Risk (%)')
ax4.set_ylabel('Expected Return (%)')

plt.tight_layout()
plt.show()

print("Generated comprehensive financial analysis dashboard")
"""

result = python_repl_tool.invoke({"code": advanced_viz_code})
print(result)
```

## üöÄ Integration with Previous Tools

### Combining All Three Tools
```python
# Example workflow combining all tools
workflow_demo = """
# This demonstrates how all three tools work together:

# 1. Wikipedia tool gets company information
# 2. Stock data tool retrieves price data  
# 3. Python tool creates visualizations

print("=== Financial Analysis Workflow Demo ===")
print("1. Wikipedia Tool: Company background research")
print("2. Stock Data Tool: Historical price retrieval") 
print("3. Python Tool: Data visualization and analysis")
print("\\nThis completes your three-tool financial analysis toolkit!")

# Sample analysis output
import matplotlib.pyplot as plt
import numpy as np

# Simulate the complete workflow
companies = ['AAPL', 'MSFT', 'TSLA']
performance = [15.2, 12.8, 22.5]  # % gains

plt.figure(figsize=(8, 5))
bars = plt.bar(companies, performance, color=['blue', 'green', 'red'], alpha=0.7)
plt.title('Q4 Stock Performance Comparison', fontsize=14)
plt.ylabel('Performance (%)')
plt.ylim(0, 25)

# Add value labels on bars
for bar, value in zip(bars, performance):
    plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.5, 
             f'{value}%', ha='center', fontweight='bold')

plt.show()
print("Analysis complete! All three tools working together.")
"""

result = python_repl_tool.invoke({"code": workflow_demo})
print(result)
```

## üìù Self-Assessment

**Check your understanding:**

‚ñ° I can create and execute Python code dynamically  
‚ñ° I understand how PythonREPL maintains execution state  
‚ñ° I can generate matplotlib visualizations through code  
‚ñ° I know how to handle code execution errors  
‚ñ° I can combine this tool with Wikipedia and stock data tools  
‚ñ° I understand the security implications of code execution  
‚ñ° I can format code output for readability  

## üîí Security Considerations

**Important Notes:**
- PythonREPL executes code in the same environment as your application
- Only execute trusted code or code generated by controlled AI agents
- Consider sandboxing for production environments
- Monitor resource usage for long-running computations
- Validate code inputs when possible

**Safe Practices:**
```python
# Good: Controlled, specific operations
safe_code = """
import numpy as np
data = np.array([1, 2, 3, 4, 5])
print(f"Mean: {data.mean()}")
"""

# Caution: File system operations
risky_code = """
import os
os.listdir('/')  # Could expose system information
"""
```

## üéâ Congratulations!

You've successfully created your complete three-tool financial analysis toolkit! This Python execution tool:

- ‚úÖ **Executes dynamic code** generated by AI agents
- ‚úÖ **Creates visualizations** with matplotlib
- ‚úÖ **Processes data** with NumPy and Pandas
- ‚úÖ **Handles errors gracefully** with proper exception handling
- ‚úÖ **Integrates seamlessly** with your other tools

**Key Takeaways:**
- PythonREPL enables dynamic code execution in agent workflows
- Proper error handling is crucial for code execution tools
- Visualization capabilities unlock powerful analysis features
- Code formatting makes output readable and professional

## üöÄ Next Steps

With all three tools completed:

1. **Activity 04:** Build a multi-agent system using all three tools
2. **Activity 05:** Create conditional workflows with intelligent tool selection
3. **Activity 06:** Add memory and context management
4. **Advanced:** Implement tool result caching and optimization

**Your Complete Toolkit:**
- üîç **Wikipedia Tool** ‚Üí Company research and background information
- üìä **Stock Data Tool** ‚Üí Historical performance data retrieval  
- üêç **Python Execution Tool** ‚Üí Dynamic analysis and visualization

Ready to build some intelligent financial analysis agents? Let's put these tools to work! üöÄüìà

## üí° Real-World Applications

**Where this pattern is used:**
- **Automated Trading Systems:** Dynamic strategy backtesting
- **Financial Research:** Custom analysis and reporting
- **Data Science Workflows:** Automated insight generation
- **Business Intelligence:** Dynamic dashboard creation
- **Educational Platforms:** Interactive coding exercises

You now have the foundation to build sophisticated AI agents that can research, analyze, and visualize financial data autonomously! üéì